name: Issue Level Guard

on:
  issues:
    types:
      - opened

permissions:
  contents: read
  issues: write

jobs:
  enforce-label:
    runs-on: ubuntu-latest
    steps:
      - name: Determine presence of required label
        id: label-check
        uses: actions/github-script@v7
        with:
          script: |
            const requiredVariants = ["my lavel", "my level"];
            const labels = (context.payload.issue.labels || []).map(label => label.name.toLowerCase().trim());

            const matchesRequired = labelName => {
              return requiredVariants.some(variant => {
                if (labelName === variant) {
                  return true;
                }

                const prefix = `${variant}:`;
                const spaced = `${variant} `;
                return labelName.startsWith(prefix) || labelName.startsWith(spaced);
              });
            };

            const hasRequired = labels.some(matchesRequired);
            core.setOutput("has-required-label", hasRequired ? "true" : "false");

      - name: Comment completion level warning
        if: steps.label-check.outputs.has-required-label == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const imageUrl = `https://raw.githubusercontent.com/${context.repo.owner}/${context.repo.repo}/main/images/level_missing.png`;
            const body = [
              "Warning: your completion lavel was missing.\n\n",
              `![Completion level missing](${imageUrl})\n\n`,
              "Please add a level label such as **bigginer**, **intermideat**, or any other appropriate option."
            ].join("");

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
